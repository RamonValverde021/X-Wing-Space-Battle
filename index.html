<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta name="author" content="Ramon Valverde">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="Jogo estilo retr√¥ de combate espacial inspirado em StarWars">
    <title>StarWars - X-Wing Space Battle</title>
    <link rel="icon" href="./images/icon-192.png">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" type="text/css" href="./css/styles.css">
    <link rel="stylesheet" type="text/css" href="./css/smartphone-size.css">
    <style>
        /* Div de sobreposi√ß√£o para o efeito de fade-to-black */
        #fade-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            opacity: 0;
            pointer-events: none;
            /* N√£o bloqueia cliques quando invis√≠vel */
            transition: opacity 5s ease-out;
            /* Dura√ß√£o da transi√ß√£o de 4 segundos */
            z-index: 20;
            /* Fica acima de tudo, exceto o v√≠deo */
        }
    </style>
</head>

<body id="index">
    <div id="fade-overlay"></div>
    <div id="rotate-device-overlay" style="display: none;">
        <span>Por favor, gire seu dispositivo para o modo paisagem.</span>
    </div>
    <div id="botoes_Index" class="painel_botoes">
        <button id="playIntro" class="botaoIndex">‚ù∞ &nbsp;&nbsp; Iniciar &nbsp; Jogo &nbsp;&nbsp; ‚ù±</button>
        <a id="btnManualControles" class="botaoIndex" href="./html/manualControles.html">‚ù∞ &nbsp;&nbsp; Controles
            &nbsp;&nbsp; ‚ù±</a>
    </div>

    <video id="introVideo" src="./images/Intro_X-Wing_Space_Battle.mp4"></video>
    <script>
        const botoes = document.getElementById("botoes_Index");
        const btnIniciar = document.getElementById("playIntro");
        const btnControles = document.getElementById("btnManualControles");
        const video = document.getElementById("introVideo");
        const fadeOverlay = document.getElementById("fade-overlay");
        let iniciouGame = true;

        // Inicia com o bot√£o Iniciar selecionado
        btnIniciar.className = "botaoIndexSelecionado";
        btnControles.className = "botaoIndex";

        btnIniciar.addEventListener("click", function () {
            // Esconde os bot√µes.
            botoes.style.display = "none"; // Esconde os bot√µes para uma transi√ß√£o mais limpa

            // Tenta entrar em modo tela cheia e travar a orienta√ß√£o
            // Isso √© ideal para jogos em dispositivos m√≥veis
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().then(() => {
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('landscape').catch(err => console.log(err));
                    }
                }).catch(err => console.log(err));
            }

            // Inicia o √°udio e o fade-in da sobreposi√ß√£o ao mesmo tempo.
            const obiWanAudio = new Audio('./audios/forca_sempre_com_vc.mp3');
            obiWanAudio.volume = 1.0;
            obiWanAudio.play();
            fadeOverlay.style.opacity = 1; // Inicia a transi√ß√£o de opacidade.

            // Quando o √°udio (e o fade) terminarem, inicia o v√≠deo.
            obiWanAudio.addEventListener("ended", () => {
                video.style.display = "block";
                video.play();
            });
        }, { once: true }); // Garante que o evento de clique seja acionado apenas uma vez

        btnIniciar.addEventListener("mouseover", () => {
            btnIniciar.className = "botaoIndexSelecionado";
            btnIniciar.style.cursor = "pointer";
            if (btnControles.className === "botaoIndexSelecionado") btnControles.className = "botaoIndex";
        });

        btnControles.addEventListener("mouseover", () => {
            btnControles.className = "botaoIndexSelecionado";
            btnControles.style.cursor = "pointer";
            if (btnIniciar.className === "botaoIndexSelecionado") btnIniciar.className = "botaoIndex";
        });

        btnIniciar.addEventListener("mouseout", () => {
            btnIniciar.className = "botaoIndex";
        });

        btnControles.addEventListener("mouseout", () => {
            btnControles.className = "botaoIndex";
        });

        // quando o v√≠deo terminar ‚Üí redireciona para o jogo
        video.addEventListener("ended", () => {
            window.location.href = "./html/game.html"; // troca para a p√°gina do game
        });

        // Script para ler entradas do controle de X-Box
        window.addEventListener("gamepadconnected", (e) => {
            // Guarda o estado dos bot√µes do frame anterior para detectar cliques (a√ß√µes de um toque)
            let prevButtons = [];
            // loop para ler as entradas do controle a cada frame
            function update() {                                               // Inicia o loop de atualiza√ß√£o que l√™ as entradas do controle a cada quadro.
                const gp = navigator.getGamepads()[e.gamepad.index];          // Pega o estado atual do gamepad conectado.
                if (!gp) {                                                    // Verifica se o gamepad foi desconectado.
                    // Se o controle for desconectado, para a nave
                    requestAnimationFrame(update);                            // Continua o loop de atualiza√ß√£o no pr√≥ximo quadro.
                    return;                                                   // Sai da fun√ß√£o neste quadro, pois n√£o h√° controle para ler.
                }
                gp.buttons.forEach((button, index) => {                                                            // Itera sobre todos os bot√µes para verificar cliques √∫nicos.
                    const foiClicado = button.pressed && (!prevButtons[index] || !prevButtons[index].pressed);     // Verifica se o bot√£o foi pressionado neste quadro, mas n√£o no anterior.
                    if (foiClicado) {
                        if (index === 9 || index === 0) {        // Bot√£o Start ou A
                            const botoes = document.getElementById("botoes_Index");
                            const btnIniciar = document.getElementById("playIntro");
                            const btnControles = document.getElementById("btnManualControles");
                            const video = document.getElementById("introVideo");
                            if (btnIniciar.className === "botaoIndexSelecionado") {
                                if (iniciouGame) {
                                    iniciouGame = false;
                                    botoes.style.display = "none"; // Esconde os bot√µes para uma transi√ß√£o mais limpa
                                    const obiWanAudio = new Audio('./audios/forca_sempre_com_vc.mp3');
                                    obiWanAudio.volume = 1.0;
                                    obiWanAudio.play();
                                    fadeOverlay.style.opacity = 1; // Inicia a transi√ß√£o de opacidade.
                                    obiWanAudio.addEventListener("ended", () => {
                                        video.style.display = "block";
                                        video.play();
                                    });
                                }
                            } else if (btnControles.className === "botaoIndexSelecionado") {
                                window.location.href = './html/manualControles.html';
                            }
                        } else if (index === 14) {               // Bot√£o Seta Esquerda
                            document.getElementById("playIntro").className = "botaoIndexSelecionado";
                            document.getElementById("btnManualControles").className = "botaoIndex";
                        } else if (index === 15) {               // Bot√£o Seta Direita
                            document.getElementById("playIntro").className = "botaoIndex";
                            document.getElementById("btnManualControles").className = "botaoIndexSelecionado";
                        }
                    }
                });
                // Salva o estado atual dos bot√µes para comparar no pr√≥ximo frame
                prevButtons = gp.buttons.map(b => ({ pressed: b.pressed, value: b.value }));  // Salva o estado atual de todos os bot√µes para a pr√≥xima verifica√ß√£o.
                requestAnimationFrame(update);                                                // Agenda a pr√≥xima execu√ß√£o da fun√ß√£o 'update' para o pr√≥ximo quadro de anima√ß√£o.
            }
            update();
        });

        window.addEventListener("gamepaddisconnected", (e) => {   // Adiciona um ouvinte de evento para quando um controle √© desconectado.
            console.log("Controle desconectado:", e.gamepad);     // Exibe no console que o controle foi desconectado.
        });







        document.addEventListener("click", async () => {
            try {
                // Entra em tela cheia
                if (document.documentElement.requestFullscreen) {
                    await document.documentElement.requestFullscreen();
                }

                // Tenta travar orienta√ß√£o
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock("landscape");
                    console.log("Tela travada em modo paisagem ‚úÖ");
                }

                // Remove o listener depois da primeira tentativa
                document.removeEventListener("click", arguments.callee);
            } catch (err) {
                console.warn("N√£o foi poss√≠vel travar a orienta√ß√£o:", err);
            }
        });

        window.addEventListener("orientationchange", () => {
            if (window.orientation === 0 || window.orientation === 180) {
                alert("Por favor, gire o dispositivo para o modo paisagem üîÑ");
            }
        });

    </script>
</body>

</html>